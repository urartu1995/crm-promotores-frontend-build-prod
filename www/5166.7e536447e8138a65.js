"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[5166],{5166:(D,m,a)=>{a.r(m),a.d(m,{OperationsListPageModule:()=>h});var u=a(177),O=a(9417),P=a(9465),C=a(5188),t=a(5990),g=a(3953);const b=[{path:"",component:t.Q}];let y=(()=>{var p;class _{}return(p=_).\u0275fac=function(v){return new(v||p)},p.\u0275mod=g.$C({type:p}),p.\u0275inj=g.G2t({imports:[C.iI.forChild(b),C.iI]}),_})();var E=a(3895),M=a(5603),I=a(3955);let h=(()=>{var p;class _{}return(p=_).\u0275fac=function(v){return new(v||p)},p.\u0275mod=g.$C({type:p}),p.\u0275inj=g.G2t({imports:[u.MD,O.YN,P.bv,y,E.b,M.P,I.h]}),_})()},5990:(D,m,a)=>{a.d(m,{Q:()=>K});var u=a(467),O=a(1413),P=a(7376),t=a(3953),g=a(5970),b=a(4501),y=a(2081),E=a(1296),M=a(9710),I=a(5188),h=a(3955),p=a(177),_=a(9465),f=a(1880),v=a(6580);const j=s=>({"crm-block-body-fixed":s}),R=s=>({"crm-button-secondary-primary":s}),S=s=>({active:s}),k=(s,c)=>({"background-color":s,border:c}),L=(s,c,n,e,i)=>({pageStartIndex:s,pageEndIndex:c,totalCount:n,paginationPage:e,sortField:i});function x(s,c){if(1&s){const n=t.RV6();t.j41(0,"div",19),t.bIt("click",function(){const i=t.eBV(n).$implicit,o=t.XpG();return t.Njj(o.onClickStep(i))}),t.j41(1,"div",20),t.EFF(2),t.k0s(),t.j41(3,"div",21),t.EFF(4),t.nrm(5,"div",22),t.k0s()()}if(2&s){const n=c.$implicit,e=t.XpG();t.Y8G("ngClass",t.eq3(4,S,null==n?null:n.isInOperationsTableActive)),t.R7$(2),t.SpI(" ",e.stepsCount[n.id]," "),t.R7$(2),t.SpI(" ",null==n?null:n.text," "),t.R7$(),t.Y8G("ngStyle",t.l_i(6,k,null==n?null:n.color,"1px solid "+(null==n?null:n.color)))}}function N(s,c){1&s&&(t.nrm(0,"i",23),t.EFF(1),t.nI1(2,"translate")),2&s&&(t.R7$(),t.SpI(" ",t.bMT(2,1,"contacts.list.close_filters")," "))}function A(s,c){1&s&&(t.nrm(0,"i",24),t.EFF(1),t.nI1(2,"translate")),2&s&&(t.R7$(),t.SpI(" ",t.bMT(2,1,"contacts.list.active_filters")," "))}function G(s,c){1&s&&(t.nrm(0,"i",24),t.EFF(1),t.nI1(2,"translate")),2&s&&(t.R7$(),t.SpI(" ",t.bMT(2,1,"contacts.list.filter")," "))}function B(s,c){if(1&s&&t.DNE(0,A,3,3)(1,G,3,3),2&s){const n=t.XpG();t.vxM(n.filters?0:1)}}function U(s,c){if(1&s){const n=t.RV6();t.j41(0,"app-list-pagination-selectors",25),t.nI1(1,"translate"),t.bIt("goPreviousPage",function(){t.eBV(n);const i=t.XpG();return t.Njj(i.onGoPreviousPage())})("goNextPage",function(){t.eBV(n);const i=t.XpG();return t.Njj(i.onGoNextPage())})("sort",function(i){t.eBV(n);const o=t.XpG();return t.Njj(o.onSort(i))}),t.k0s()}if(2&s){const n=t.XpG();t.Y8G("listPaginationConfig",t.s1E(3,L,n.updatePagination().startIndex,n.updatePagination().endIndex,n.allSystemOperationsCount,n.pagination.page+1,null!=n.sort&&n.sort.field?(null==n.sort?null:n.sort.field)+" "+(null==n.sort?null:n.sort.order):t.bMT(1,1,"contacts.list.default_sort")))}}function F(s,c){if(1&s){const n=t.RV6();t.j41(0,"div",16)(1,"app-list-pagination-selectors",25),t.nI1(2,"translate"),t.bIt("goPreviousPage",function(){t.eBV(n);const i=t.XpG();return t.Njj(i.onGoPreviousPage())})("goNextPage",function(){t.eBV(n);const i=t.XpG();return t.Njj(i.onGoNextPage())})("sort",function(i){t.eBV(n);const o=t.XpG();return t.Njj(o.onSort(i))}),t.k0s()()}if(2&s){const n=t.XpG();t.R7$(),t.Y8G("listPaginationConfig",t.s1E(3,L,n.updatePagination().startIndex,n.updatePagination().endIndex,n.allSystemOperationsCount,n.pagination.page+1,null!=n.sort&&n.sort.field?(null==n.sort?null:n.sort.field)+" "+(null==n.sort?null:n.sort.order):t.bMT(2,1,"contacts.list.default_sort")))}}function X(s,c){}function W(s,c){if(1&s){const n=t.RV6();t.j41(0,"app-table",26),t.bIt("columnClick",function(i){t.eBV(n);const o=t.XpG();return t.Njj(o.onColumnClicked(i))})("rowClicked",function(i){t.eBV(n);const o=t.XpG();return t.Njj(o.onRowClicked(i))}),t.k0s()}if(2&s){const n=t.XpG();t.Y8G("table",n.tableConfig)}}let K=(()=>{var s;class c{constructor(e,i,o,l,r,d,T){this.popoversService=e,this.headerService=i,this.sdk=o,this.tableService=l,this.modalService=r,this.activatedRoute=d,this.translate=T,this.pipeline=null,this.operations=[],this.allSystemOperationsCount=0,this.checkedOperations=0,this.searchString="",this.searchSubject=new O.B,this.aside={type:"filters",visible:!1},this.pipelineName="operaciones",this.showFilters=!1,this.filters=null,this.sort=null,this.pagination={page:0,itemsPerPage:25},this.tableConfig={uniqueId:"table-1",showSelectors:!0,columns:[{key:"currentPipelineStep.text",label:this.translate.instant("operation.table.stage"),size:"medium"},{key:"contact.name",label:this.translate.instant("operation.table.contact"),size:"large"},{key:"mainProperty.promotion.projectName",label:this.translate.instant("operation.table.promotion"),size:"large"},{key:"mainProperty.reference",label:this.translate.instant("operation.table.identifier"),size:"large"},{key:"mainProperty.availabilityStatus",label:this.translate.instant("operation.table.property_status"),size:"medium"},{key:"createdAt",label:this.translate.instant("operation.table.created"),size:"medium"},{key:"responsible.name",label:this.translate.instant("operation.table.responsible"),size:"large"}],rows:[]},this.relationsFilter={mainProperty:{apply:!0,filter:null,onlyCount:!1},currentPipelineStep:{apply:!0,filter:null,onlyCount:!1},contact:{apply:!0,filter:null,onlyCount:!1},currentPipeline:{apply:!0,filter:{title:{equals:this.pipelineName}},onlyCount:!1}},this.loadingList=!1,this.stepsCount={}}ionViewWillEnter(){this.getData()}ngOnInit(){var e;null!==(e=this.options)&&void 0!==e&&e.fatherObj&&(this.relationsFilter.operations={apply:!0,filter:{agencyId:{equals:this.options.fatherObj.id}},onlyCount:!1},this.getData())}getData(){var e=this;return(0,u.A)(function*(){yield e.getOperationNameInUrl(),yield e.getPipelines(),yield e.getOperations(),yield e.getOperationsStepsCount()})()}getOperationNameInUrl(){var e=this;return(0,u.A)(function*(){var i;e.pipelineName=e.activatedRoute.snapshot.params.pipelineName||"operaciones",console.log("pipelineName",e.pipelineName),e.relationsFilter.currentPipeline.filter.title.equals=e.pipelineName,null!==(i=e.options)&&void 0!==i&&i.fatherObj||e.headerService.setConfig({title:"operations/"+e.pipelineName})})()}getOperationsStepsCount(){var e=this;return(0,u.A)(function*(){var i,o;if(!e.pipeline)return;let l={};var r;null!==(i=e.options)&&void 0!==i&&i.fatherObj&&(l={agencyId:null===(r=e.options)||void 0===r||null===(r=r.fatherObj)||void 0===r?void 0:r.id});const d=yield e.sdk.countOperationsPerStep(e.pipeline.id,l);e.stepsCount=null===(o=d.success)||void 0===o?void 0:o.data})()}getPipelines(){var e=this;return(0,u.A)(function*(){const i=yield e.sdk.getPipelines({title:{equals:e.pipelineName}},{field:"createdAt",order:"asc"},{itemsPerPage:200,page:0},{steps:{filter:null,apply:!0,onlyCount:!1},buttons:{filter:null,apply:!0,onlyCount:!1}});if(i.success){var o;const l=null==i||null===(o=i.success)||void 0===o?void 0:o.data[0],r=P.cloneDeep(null==l?void 0:l.steps)||[];r.sort((d,T)=>d.order-T.order),l.steps=r,e.pipeline=l}})()}getOperations(){var e=this;return(0,u.A)(function*(){const i=yield e.sdk.getOperation(e.filters,e.sort,e.pagination,e.relationsFilter);if(console.log("this.relationsFilter",JSON.parse(JSON.stringify(e.relationsFilter))),i.success){e.operations=i.success.data;let o=e.tableService.convertDataToTableRows(e.operations,e.tableConfig);o=e.tableService.setRowsChipsFromOperations(o),o=o.map(l=>{var r;return null!=l&&null!==(r=l.rawObject)&&void 0!==r&&r.viewed||(l.style={backgroundColor:"success"}),l}),e.tableConfig.rows=o}})()}setCountsOfPipelinesSteps(){var e=this;return(0,u.A)(function*(){for(let o=0;o<(null===(i=e.pipeline)||void 0===i||null===(i=i.steps)||void 0===i?void 0:i.length);o++)var i})()}onClickStep(e){if(null!=e&&e.isInOperationsTableActive){var i;const l=(null===(i=this.filters)||void 0===i?void 0:i.OR)||[],r=l.findIndex(d=>d.currentPipelineStepId.equals===e.id);l.splice(r,1),this.pipeline.steps.forEach(d=>{d.id===e.id&&(d.isInOperationsTableActive=!1)}),this.filters=0===l.length?null:{OR:l}}else{var o;const l=(null===(o=this.filters)||void 0===o?void 0:o.OR)||[];l.push({currentPipelineStepId:{equals:e.id}}),this.pipeline.steps.forEach(r=>{r.id===e.id&&(r.isInOperationsTableActive=!0)}),this.filters={OR:l}}this.getOperations()}onSearchInputChange(e){this.searchSubject.next(e.target.value)}onSearchChanged(e){this.searchString=e}onToggleAside(){this.aside.visible=!this.aside.visible}onGoNextPage(){(this.pagination.page+1)*this.pagination.itemsPerPage<this.allSystemOperationsCount&&(this.pagination.page++,this.getData())}onGoPreviousPage(){this.pagination.page>0&&(this.pagination.page--,this.getData())}onToggleAllCheckboxes(e){}onShowMenuSelectAll(e){}onSort(e){}onRowClicked(e){var i=this;return(0,u.A)(function*(){const o=e.rawObject;console.log("operation",o),yield(yield i.modalService.showOperationModal(null==o?void 0:o.id)).onDidDismiss(),i.getOperations()})()}onColumnClicked(e){var i=this;return(0,u.A)(function*(){i.sort={field:e.column.key,order:e.order},i.getData()})()}onClickMoreTools(e){var i=this;return(0,u.A)(function*(){const o=yield i.popoversService.onShowMenuPopover(e,"contacts-list-more-tools");console.log("Popover result:",o)})()}updatePagination(){return{startIndex:this.pagination.page*this.pagination.itemsPerPage+1,endIndex:Math.min((this.pagination.page+1)*this.pagination.itemsPerPage,this.allSystemOperationsCount)}}}return(s=c).\u0275fac=function(e){return new(e||s)(t.rXU(g.m),t.rXU(b.d),t.rXU(y.i),t.rXU(E.a),t.rXU(M.M),t.rXU(I.nX),t.rXU(h.c$))},s.\u0275cmp=t.VBU({type:s,selectors:[["app-operations-list"]],inputs:{options:"options"},decls:24,vars:15,consts:[[3,"fullscreen","scrollY"],[1,"crm-block-content"],[1,"crm-block-body"],[3,"ngClass"],[1,"crm-section-operations-list-buttons"],[1,"crm-operations-list-pipe-button",3,"ngClass"],[1,"crm-header-modal"],[1,"crm-input"],[1,"crm-input-input","crm-input-input-searchbar"],[1,"fas","fa-search"],["type","text",3,"input","placeholder"],[1,"crm-buttons-group"],[1,"crm-button-secondary",3,"click","ngClass"],[1,"crm-button-secondary","crm-button-secondary-icon-solo",3,"click"],[1,"fa","fa-ellipsis"],[3,"listPaginationConfig"],[1,"crm-block-body-fixed","crm-block-body-fixed-padding-bigger"],[1,"crm-block-body-blue-content"],[3,"table"],[1,"crm-operations-list-pipe-button",3,"click","ngClass"],[1,"crm-operations-list-pipe-button-title"],[1,"crm-operations-list-pipe-button-subtitle"],[1,"crm-dot","success",3,"ngStyle"],[1,"fa","fa-times"],[1,"fa","fa-filter"],[3,"goPreviousPage","goNextPage","sort","listPaginationConfig"],[3,"columnClick","rowClicked","table"]],template:function(e,i){1&e&&(t.j41(0,"ion-content",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"div",4),t.Z7z(5,x,6,9,"div",5,t.fX1),t.k0s(),t.j41(7,"div",6)(8,"div",7)(9,"div",8),t.nrm(10,"i",9),t.j41(11,"input",10),t.nI1(12,"translate"),t.bIt("input",function(l){return i.onSearchInputChange(l)}),t.k0s()()(),t.j41(13,"div",11)(14,"button",12),t.bIt("click",function(){return i.onToggleAside()}),t.DNE(15,N,3,3)(16,B,2,1),t.k0s(),t.j41(17,"button",13),t.bIt("click",function(l){return i.onClickMoreTools(l)}),t.nrm(18,"i",14),t.k0s()()(),t.DNE(19,U,2,9,"app-list-pagination-selectors",15),t.k0s(),t.DNE(20,F,3,9,"div",16),t.j41(21,"div",17),t.DNE(22,X,0,0)(23,W,1,1,"app-table",18),t.k0s()()()()),2&e&&(t.Y8G("fullscreen",!0)("scrollY",!1),t.R7$(3),t.Y8G("ngClass",t.eq3(11,j,!(null!=i.options&&i.options.fatherObj))),t.R7$(2),t.Dyx(null==i.pipeline?null:i.pipeline.steps),t.R7$(6),t.Y8G("placeholder",t.bMT(12,9,"contacts.list.search_placeholder_operation")),t.R7$(3),t.Y8G("ngClass",t.eq3(13,R,!("filters"===(null==i.aside?null:i.aside.type)&&null!=i.aside&&i.aside.visible)&&i.filters)),t.R7$(),t.vxM("filters"===(null==i.aside?null:i.aside.type)&&null!=i.aside&&i.aside.visible?15:16),t.R7$(4),t.vxM(null!=i.options&&i.options.fatherObj?-1:19),t.R7$(),t.vxM(null!=i.options&&i.options.fatherObj?20:-1),t.R7$(2),t.vxM(i.loadingList?22:23))},dependencies:[p.YU,p.B3,_.W9,f.O,v.k,h.D9]}),c})()}}]);